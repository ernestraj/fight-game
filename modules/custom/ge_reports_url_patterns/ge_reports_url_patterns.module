<?php

/**
 * @file
 * Search url in selected fields export in excel file..
 */

/**
 * Implements hook_menu().
 */
function ge_reports_url_patterns_menu() {
    $items = array();
    $items['admin/reports-url-patterns'] = array(
        'title' => 'Search url in Database',
        'type' => MENU_CALLBACK,
        'page callback' => 'drupal_get_form',
        'page arguments' => array('reports_url_patterns_query'),
        'access arguments' => array('access reports url patterns form'),
    );

    return $items;
}

function ge_reports_url_patterns_permission() {
    return array(
        'access reports url patterns form' => array(
            'title' => t('Access reports url patterns form section'),
            'description' => t('View reports url patterns form section.'),
        ),
    );
}

/**
 * function for getting current user all counrty list.
 */
function _get_user_portal_list() {
    global $user;
    $uid = $user->uid;
    $sql = "SELECT taxonomy_term_data.tid AS tid,country_fullname.field_country_name_value as country_full_name FROM {taxonomy_term_data} taxonomy_term_data LEFT JOIN {field_data_field_country} field_data_field_country ON taxonomy_term_data.tid = field_data_field_country.field_country_tid AND (field_data_field_country.entity_type = 'user' AND field_data_field_country.deleted = '0') LEFT JOIN {users} field_country_taxonomy_term_data ON field_data_field_country.entity_id = field_country_taxonomy_term_data.uid LEFT JOIN {taxonomy_vocabulary} taxonomy_vocabulary ON taxonomy_term_data.vid = taxonomy_vocabulary.vid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = taxonomy_term_data.tid WHERE (( (taxonomy_vocabulary.machine_name IN  ('country')) AND( (field_country_taxonomy_term_data.uid =:uid) )))";
    $result = db_query($sql, array(':uid' => $uid));
    $country_options = array('any' => '-Any-');
    foreach ($result as $data) {
        $country_options[$data->tid] = $data->country_full_name;
    }
    return $country_options;
}

function reports_url_patterns_query($form, &$form_state) {
    $form['#attached']['js'] = array(
        drupal_get_path('module', 'ge_reports_url_patterns') . '/js/reports_url_patterns.js',
    );
    $form['#attached']['css'] = array(
        drupal_get_path('module', 'ge_reports_url_patterns') . '/js/reports_url_patterns.css',
    );

    $form['filter_option'] = array(
        '#title' => t('Select filter option'),
        '#type' => 'select',
        '#required' => TRUE,
        '#description' => 'Select the desired filter option.',
        '#options' => array(
            'all' => t('Search in all fields'),
            'description' => t('Search in Description field'),
            'url' => t('Search in URL field'),
            'page_body' => t('Search in Page Body field'),
            'group_body' => t('Search in Group Body field'),
            'section_body' => t('Search in Section Body field'),
            'link_url' => t('Search in Link URL field'),
        )
    );
    $form['portal'] = array(
        '#title' => t('Select portal'),
        '#type' => 'select',
        '#required' => TRUE,
        '#description' => 'Select the desired portal option.',
        '#options' => _get_user_portal_list()
    );

    $form['result_option'] = array(
        '#type' => 'radios',
        '#default_value' => 1,
        '#title' => t('Select output option'),
        '#description' => t('Select a method for reporting.'),
        '#options' => array(
            t('Download results in excel file'),
            t('Show result here'),
        )
    );

    $form['filterby_text'] = array(
        '#type' => 'textfield',
        '#title' => 'Enter the URL pattern here',
        '#required' => true
    );

    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Search Content'),
    );

    // the form has been submitted and rebuilt
    if (isset($form_state['result']['result_value'])) {
        $form['result_value_display'] = array
            (
            '#markup' => $form_state['result']['result_value'],
        );
    }

    return $form;
}

/**
 * Form submission handler, which functions like a hook.
 */
function reports_url_patterns_query_submit($form, &$form_state) {
    if ($form_state['values']['submit'] == 'Search Content') {

        // GET INPUT QUERY STATEMENT
        $filter_option = $form_state['values']['filter_option'];
        $filterby_text = $form_state['values']['filterby_text'];
        $portal = $form_state['values']['portal'];
        // PREPARE DESIRED QUERY STATEMENT ACCORDING TO THE FILTER BY OPTION
        $sql = '';
        if ($portal == 'any') {
            $portal_condition = '';
        } 
        else {
            $portal_condition = " AND (field_country.field_country_tid = " . $portal . ")";
        }
        if ($filter_option == 'description') {
            $sql = "SELECT DISTINCT node.nid AS Nid, node.title AS node_title, node.type AS Type,field_data_field_description.field_description_value as Description,country_fullname.field_country_name_value as Portal_name  FROM {node node} LEFT JOIN {field_data_field_link_type_new} field_data_field_link_type_new ON node.nid = field_data_field_link_type_new.entity_id AND (field_data_field_link_type_new.entity_type = 'node' AND field_data_field_link_type_new.deleted = '0') LEFT JOIN {field_collection_item} field_collection_item_field_data_field_link_type_new ON field_data_field_link_type_new.field_link_type_new_value = field_collection_item_field_data_field_link_type_new.item_id LEFT JOIN {field_data_field_description} field_data_field_description ON node.nid = field_data_field_description.entity_id  AND field_data_field_description.deleted = '0' LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = node.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE ((( (field_data_field_description.field_description_value LIKE '%" . $filterby_text . "%' ESCAPE '\\\') " . $portal_condition . "))) ORDER BY nid DESC";
        } 
        elseif ($filter_option == 'url') {
            $sql = "SELECT n.nid as Nid, n.title as Title, n.type as Type,country_fullname.field_country_name_value as Portal_name,ur.field_url_url URL, ur.field_url_title URL_Title FROM {field_data_field_url} ur INNER JOIN {field_data_field_urls}  u on ur.entity_id= u.field_urls_value LEFT JOIN {node} n ON n.nid = u.entity_id LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = n.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE (field_url_url LIKE '%" . $filterby_text . "%')" . $portal_condition . "";
        } 
        elseif ($filter_option == 'page_body') {
            $sql = "SELECT n.nid as Nid, n.title as Title, n.type as Type, b.body_value as Body, b.body_summary as Summary,country_fullname.field_country_name_value as Portal_name FROM {field_data_body} b LEFT JOIN {node} n ON n.nid = b.entity_id LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = n.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE b.body_value like '%" . $filterby_text . "%' " . $portal_condition . "";
        }
        elseif ($filter_option == 'group_body') {
            $sql = "SELECT n.nid as Nid, n.title as Title, n.type as Type,fb.field_body_value as Group_body,fb.field_body_summary as Group_body_summary,country_fullname.field_country_name_value as Portal_name FROM {field_data_field_body} fb  INNER JOIN {field_data_field_group} fg ON fg.field_group_value = fb.entity_id LEFT JOIN {node} n ON n.nid = fg.entity_id LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = n.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE (fb.field_body_value like '%" . $filterby_text . "%') AND (fb.bundle = 'field_group') " . $portal_condition . "";
        }
        elseif ($filter_option == 'section_body') {
            $sql = "SELECT n.nid as Nid, n.title as Title, n.type as Type, fb.field_body_value as Group_body,fb.field_body_summary as Group_body_summary,country_fullname.field_country_name_value as Portal_name FROM {field_data_field_body} fb INNER JOIN  {field_data_field_section} sb ON sb.field_section_value = fb.entity_id INNER JOIN {field_data_field_group} fg ON fg.field_group_value = sb.entity_id LEFT JOIN {node} n ON n.nid = fg.entity_id LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = n.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE (fb.field_body_value like '%" . $filterby_text . "%') AND (fb.bundle = 'field_section') " . $portal_condition . "";
        }
        elseif ($filter_option == 'link_url') {
            $sql = "SELECT n.nid as Nid, n.title as Title, n.type as Type, li.field_link_url as Link_URL, li.field_link_title as Link_Title,country_fullname.field_country_name_value as Portal_name FROM {field_data_field_link} li inner join {field_data_field_link_type_new} l on li.entity_id=l.field_link_type_new_value inner join  {field_data_field_section} s on l.entity_id=s.field_section_value left join {field_data_field_group} g on s.entity_id=g.field_group_value LEFT JOIN {node} n ON n.nid = li.entity_id LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = n.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE (field_link_url LIKE '%" . $filterby_text . "%') " . $portal_condition . "";
        }
        elseif ($filter_option == 'all') {
            $sql = "SELECT DISTINCT node.nid AS Nid, node.title AS Title, node.type AS Node_type,country_fullname.field_country_name_value as Portal_name FROM {node} node LEFT JOIN {field_data_field_link_type_new} field_data_field_link_type_new ON node.nid = field_data_field_link_type_new.entity_id AND (field_data_field_link_type_new.entity_type = 'node' AND field_data_field_link_type_new.deleted = '0') LEFT JOIN {field_collection_item} field_collection_item_field_data_field_link_type_new ON field_data_field_link_type_new.field_link_type_new_value = field_collection_item_field_data_field_link_type_new.item_id LEFT JOIN {field_data_field_description} field_data_field_description ON node.nid = field_data_field_description.entity_id AND (field_data_field_description.entity_type = 'node' AND field_data_field_description.deleted = '0') LEFT JOIN {field_data_field_link} field_collection_item_field_data_field_link_type_new__field_data_field_link ON field_collection_item_field_data_field_link_type_new.item_id = field_collection_item_field_data_field_link_type_new__field_data_field_link.entity_id AND (field_collection_item_field_data_field_link_type_new__field_data_field_link.entity_type = 'field_collection_item' AND field_collection_item_field_data_field_link_type_new__field_data_field_link.deleted = '0') LEFT JOIN {field_data_body} field_data_body ON node.nid = field_data_body.entity_id AND (field_data_body.entity_type = 'node' AND field_data_body.deleted = '0') LEFT JOIN {field_data_field_url} field_data_field_url ON node.nid = field_data_field_url.entity_id AND (field_data_field_url.entity_type = 'node' AND field_data_field_url.deleted = '0') LEFT JOIN {field_data_field_body} field_collection_item_field_data_field_link_type_new__field_data_field_body ON field_collection_item_field_data_field_link_type_new.item_id = field_collection_item_field_data_field_link_type_new__field_data_field_body.entity_id AND (field_collection_item_field_data_field_link_type_new__field_data_field_body.entity_type = 'field_collection_item' AND field_collection_item_field_data_field_link_type_new__field_data_field_body.deleted = '0') LEFT JOIN {field_data_field_country} field_country ON field_country.entity_id = node.nid LEFT JOIN {field_data_field_country_name} country_fullname ON country_fullname.entity_id = field_country.field_country_tid WHERE ((( (field_data_field_description.field_description_value LIKE '%" . $filterby_text . "%' ESCAPE '\\\') )OR( (field_collection_item_field_data_field_link_type_new__field_data_field_link.field_link_url LIKE '%" . $filterby_text . "%' ESCAPE '\\\') ))OR(( (field_data_body.body_value LIKE '%" . $filterby_text . "%' ESCAPE '\\\') )OR( (field_data_field_url.field_url_url LIKE '%" . $filterby_text . "%' ESCAPE '\\\') ))OR(( (field_collection_item_field_data_field_link_type_new__field_data_field_body.field_body_value LIKE '%" . $filterby_text . "%' ESCAPE '\\\') ))) " . $portal_condition . " ORDER BY nid DESC";
        }

        $result = db_query($sql);

        //IF RESULT OPTION IS DOWNLOAD EXCEL FILE 
        if ($form_state['values']['result_option'] == 0) {
            // Prevent Devel from messing us up.
            $GLOBALS['devel_shutdown'] = TRUE;
            // Set the headers to indicate this is a CSV file.
            header('Content-type: text/csv; charset=UTF-8');
            header('Content-Disposition: attachment; filename=url-patterns-reports.csv');
            header('Pragma: no-cache');
            header('Expires: 0');
            // Create a file.
            $output = fopen('php://output', 'w');

            $result1 = $result->fetchAssoc();
            // Column names.
            // get the all coulmns name as header
            fputcsv($output, array_keys($result1));
            fputcsv($output, (array) $result1);
            // Loop through the rows.
            foreach ($result as $row) {
                fputcsv($output, (array) $row);
            }
            fclose($output);
            exit;
        }
        else {
            $result1 = $result->fetchAssoc();
            if (is_array($result1)) {
                $output = array();
                $headers = array_keys($result1);
                // Add field value in show/hide wrapper
                if ($filter_option == 'description') {
                    $result1['Description'] = '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $result1['Description'] . '</div>';
                } 
                elseif ($filter_option == 'page_body') {
                    $result1['Body'] = '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $result1['Body'] . '</div>';
                    $result1['Summary'] = !empty($result1['Summary']) ? '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $result1['Summary'] . '</div>' : $result1['Summary'];
                } 
                elseif ($filter_option == 'group_body' || $filter_option == 'section_body') {
                    $result1['Group_body'] = '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $result1['Group_body'] . '</div>';
                    $result1['Group_body'] = str_replace("<script", "<!-- <script", $result1['Group_body']);
                    $result1['Group_body'] = str_replace("</script>", "</script> -->", $result1['Group_body']);
                    $result1['Group_body_summary'] = !empty($result1['Group_body_summary']) ? '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $result1['Group_body_summary'] . '</div>' : $result1['Group_body_summary'];
                }

                $rows[] = $result1;

                while ($data = $result->fetchAssoc()) {
                    // Add field value in show/hide wrapper
                    if ($filter_option == 'description') {
                        $data['Description'] = '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $data['Description'] . '</div>';
                    } 
                    elseif ($filter_option == 'page_body') {
                        $data['Body'] = '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $data['Body'] . '</div>';
                        $data['Summary'] = !empty($data['Summary']) ? '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $data['Summary'] . '</div>' : $data['Summary'];
                    } 
                    elseif ($filter_option == 'group_body' || $filter_option == 'section_body') {
                        $data['Group_body'] = '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $data['Group_body'] . '</div>';
                        $data['Group_body'] = str_replace("<script", "<!-- <script", $data['Group_body']);
                        $data['Group_body'] = str_replace("</script>", "</script> -->", $data['Group_body']);
                        $data['Group_body_summary'] = !empty($data['Group_body_summary']) ? '<span class="view-field-data"><a href="#">View Field Data</a></span><div class="view-field-data">' . $data['Group_body_summary'] . '</div>' : $data['Group_body_summary'];
                    }

                    $rows[] = $data;
                }
                $table_data = array(
                    'header' => $headers,
                    'rows' => $rows,
                    'sticky' => TRUE,
                    'empty' => 'No results found',
                    'attributes' => array(),
                    'colgroups' => array(),
                    'caption' => t('<b>Total&nbsp;') . count($rows) . t('&nbsp;result found</b><br/>'),
                    'id' => 'ralphs-node-table',
                );
                $output = theme_table($table_data);
            }
            $form_state['result']['result_value'] = $output;
            $form_state['rebuild'] = TRUE;
        }
    }
}
